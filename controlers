const { Time, Jogador, Tecnico, Presidente } = require("../db/models")

async function renderTimes(req, res) {
    const times = await Time.findAll({
        where: { administrador_id: req.user.id },
        include: [
            { model: Jogador, as: "jogadores" },
            { model: Tecnico, as: "tecnico" },
            { model: Presidente, as: "presidente" }
        ]
    })
    res.render("times/index", { times })
}

function renderRegister(_, res) {
    res.render("times/registrar")
}

async function register(req, res) {
    const { nome, estadio, cidade, presidenteNome, tecnicoNome } = req.body

    if (!nome || !estadio || !cidade || !presidenteNome || !tecnicoNome)
        return res.redirect("/times/registrar?msg=Preencha%20todos%20os%20campos")

    try {
        const time = await Time.create({
            nome,
            estadio,
            cidade,
            administrador_id: req.user.id
        })

        await Presidente.create({
            nome: presidenteNome,
            time_id: time.id
        })

        await Tecnico.create({
            nome: tecnicoNome,
            time_id: time.id
        })

        res.redirect("/times?msg=Time%20registrado%20com%20sucesso&status=success")
    } catch (err) {
        res.redirect("/times?msg=Erro%20ao%20registrar%20time")
    }
}

function renderEdit(req, res) {
    Time.findByPk(req.params.id, {
        include: [
            { model: Jogador, as: "jogadores" },
            { model: Tecnico, as: "tecnico" },
            { model: Presidente, as: "presidente" }
        ]
    }).then(time => {
        if (!time) return res.redirect("/times")
        res.render("times/editar", { ...time.dataValues })
    })
}

async function edit(req, res) {
    const { nome, estadio, cidade, presidenteNome, tecnicoNome } = req.body

    if (!nome || !estadio || !cidade || !presidenteNome || !tecnicoNome)
        return res.redirect(`/times/${req.params.id}/editar?msg=Preencha%20todos%20os%20campos`)

    try {
        await Time.update(
            { nome, estadio, cidade },
            { where: { id: req.params.id } }
        )

        await Presidente.update(
            { nome: presidenteNome },
            { where: { time_id: req.params.id } }
        )

        await Tecnico.update(
            { nome: tecnicoNome },
            { where: { time_id: req.params.id } }
        )

        res.redirect("/times?msg=Time%20editado%20com%20sucesso&status=success")
    } catch (err) {
        res.redirect("/times?msg=Erro%20ao%20editar%20time")
    }
}

async function remove(req, res) {
    try {
        await Time.destroy({
            where: { id: req.params.id }
        })
    } catch (
